---
title: "Global N-BEATS Forecast with darts (via reticulate)"
format: html
---

```{r setup, include=FALSE}
# Knitr options
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
library(readr); library(dplyr); library(lubridate); library(reticulate)

# Use the conda env where you installed packages
use_condaenv("darts-conda", required = TRUE)
# use_virtualenv("darts-env", required = FALSE)  # leave commented
```

## Setup

- Interface to Python via `reticulate`.
- Use the `darts` library for global time-series modeling with N-BEATS.

```{r parameters}
# Path to CSV with columns: ds (date), unique_id (series id), y (target)
data_file <- "data/sales_ds_uniqueid_y.csv"

# Forecast horizon (number of steps ahead)
horizon <- 28

# N-BEATS hyperparameters
input_chunk_length  <- 28
output_chunk_length <- 14
n_epochs            <- 3
```

## Data Loading

```{r load-data}
data_file <- "data/train_data.rds"  # or "data/validation_data.rds"

sales_df <- readRDS(data_file) |>
  as_tibble() |>
  transmute(
    ds        = as.Date(date),
    unique_id = id,         # can paste(item_id, store_id, sep = "_")
    y         = units
  ) |>
  arrange(unique_id, ds) |>
  tidyr::drop_na(ds, unique_id, y)
```

## Preprocessing

Optionally filter or aggregate here if we need to reduce data size or som

```{r preprocess}
sales_df <- sales_df |>
  arrange(unique_id, ds) |>
  tidyr::drop_na(ds, unique_id, y)
```

## Model Training (Python / darts)

```{python model}

import os
import pandas as pd
from darts import TimeSeries
from darts.models import NBEATSModel
from darts.utils.timeseries_generation import datetime_attribute_timeseries
from darts.dataprocessing.transformers import Scaler

# Receive data from R
sales_df = r["sales_df"]

# Ensure proper dtypes for darts
sales_df["ds"] = pd.to_datetime(sales_df["ds"])
sales_df["unique_id"] = sales_df["unique_id"].astype(str)
sales_df["y"] = pd.to_numeric(sales_df["y"], errors="coerce")
# Build list of TimeSeries objects, one per unique_id
series_list = TimeSeries.from_group_dataframe(
    sales_df,
    group_cols="unique_id",
    time_col="ds",
    value_cols="y",
    fill_missing_dates=True,
    freq=None  # auto-infer frequency per group
)

# Optional: create future covariates (calendar-based) aligned to each series
covariates_list = []
use_covariates = True

for ts in series_list:
    cov = datetime_attribute_timeseries(ts, attribute="month", one_hot=True)
    cov = cov.stack(datetime_attribute_timeseries(ts, attribute="dayofweek", one_hot=True))
    cov = cov.with_columns_renamed(cov.columns, [f"cal_{c}" for c in cov.columns])
    cov = cov.slice_intersect(ts)
    covariates_list.append(cov if use_covariates else None)

# Scale targets (optional but recommended)
scaler = Scaler()
series_list_scaled = scaler.fit_transform(series_list)

# Fit global N-BEATS
model = NBEATSModel(
    input_chunk_length=int(r["input_chunk_length"]),
    output_chunk_length=int(r["output_chunk_length"]),
    n_epochs=int(r["n_epochs"]),
    random_state=42,
    model_name="nbeats-global",
    force_reset=True,
    save_checkpoints=False
)

model.fit(
    series=series_list_scaled,
    past_covariates=covariates_list if use_covariates else None,
    verbose=True
)
```

## Forecasting

```{python forecast}
forecast_horizon = int(r["horizon"])

# Generate forecasts for each series
forecasts_scaled = model.predict(
    n=forecast_horizon,
    series=series_list_scaled,
    past_covariates=covariates_list if use_covariates else None,
    verbose=True
)

# Inverse scale to original units
forecasts = scaler.inverse_transform(forecasts_scaled)

# Collect forecasts to a DataFrame
fcst_dfs = []
for ts, fc in zip(series_list, forecasts):
    df_fc = fc.pd_dataframe().reset_index().rename(columns={"time": "ds", fc.columns[0]: "yhat"})
    df_fc["unique_id"] = ts.static_covariates.get("group") if ts.static_covariates is not None else ts.components[0]
    fcst_dfs.append(df_fc)

forecast_df = pd.concat(fcst_dfs, ignore_index=True)
forecast_df
```

## Plotting / Output

```{python plotting}
import matplotlib.pyplot as plt

os.makedirs("figures", exist_ok=True)

# Plot first series as example
fig, ax = plt.subplots(figsize=(10, 4))
series_list[0].plot(ax=ax, label="history")
forecasts[0].plot(ax=ax, label="forecast")
ax.legend()
ax.set_title("N-BEATS Forecast (example series)")

plot_path = "figures/nbeats_forecast.png"
plt.tight_layout()
plt.savefig(plot_path, dpi=150)
plot_path
```

## Save Forecasts

```{python save-forecast}
output_path = "figures/nbeats_forecasts.csv"
forecast_df.to_csv(output_path, index=False)
output_path
```

## Notes

- Update `data_file` to point to the CSV containing columns `ds`, `unique_id`, and `y`
- Adjust `use_covariates` or covariate definitions if you do not want calendar features
- Ensure your active Python environment has `u8darts`, `pandas`, `matplotlib`, and `torch` installed